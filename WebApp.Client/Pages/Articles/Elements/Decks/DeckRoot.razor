@using AnkiBooks.ApplicationCore.Entities
@using AnkiBooks.ApplicationCore.Enums

@using AnkiBooks.WebApp.Client.Pages.Articles.Elements
@using AnkiBooks.WebApp.Client.Pages.Articles.Elements.Decks.Cards
@using AnkiBooks.WebApp.Client.Pages.Articles.Elements.Decks.Cards.Basic
@using AnkiBooks.WebApp.Client.Pages.Articles.Elements.Decks.Cards.Cloze

@inherits ArticleElementRootBase<Deck>

@if (Editing == true)
{
    <EditDeck InitialArticleElement="@ArticleElement" @bind-Editing="@Editing" />
}
else
{
    <div class="d-flex flex-row justify-content-between align-items-center">
        <h2 class="font-size-2xl">
            @ArticleElement.Name
        </h2>

        @if (showingOptions == false)
        {
            <div class="d-flex flex-row justify-content-start">
                <div class="w-5 h-5 mr-2" role="button" title="Edit markdown" @onclick="StartEditing">
                    <Edit />
                </div>

                <div role="button" class="w-5 h-5" title="Options" @onclick="ShowOptions">
                    <Gear />
                </div>
            </div>
        }
        else
        {
            <div class="position-relative top-4 right-4 px-2 border-primary">
                <ul>
                    <li class="my-2" @onclick="CancelShowingOptions">Cancel</li>
                    <li class="my-2" @onclick="DeleteArticleElement">Delete deck</li>
                </ul>
            </div>
        }
    </div>

    @if (!String.IsNullOrWhiteSpace(@ArticleElement.Description))
    {
        <p class="my-4">
            @ArticleElement.Description    
        </p>
    }

    <div class="my-4">
        @(Cards.Count) cards
    </div>

    <div class="my-4 d-flex flex-row justify-content-start align-items-center">
        <div class="mr-4">
            @if (studyingDeck == false)
            {
                <button type="button" class="btn btn-primary" title="Study deck" @onclick="StudyDeck">
                    Study deck
                </button>
            }
            else
            {
                <button type="button" class="btn btn-primary" title="Done studying" @onclick="CancelStudyDeck">
                    Done studying
                </button>
            }
        </div>
        @if (newCardSelection == null)
        {
            <div>
                <InputSelect @bind-Value="newCardSelection" name="new-card">
                    <option value="" selected>New card</option>
                    <option value="@CardType.BasicNote">Basic</option>
                    <option value="@CardType.ClozeNote">Cloze</option>
                </InputSelect>
            </div>
        }
    </div>

    @if (studyingDeck == true)
    {
        <div class="my-4">
            @if (currentCard == null)
            {
                <p class="text-center">Congratulations! You have completed studying this deck (no cards are due right now).</p>
            }
            else
            {
                <div class="d-flex flex-row justify-content-center">
                    <CardRoot Card="@currentCard" @bind-AnswerRevealed="currentCardAnswerRevealed" />
                </div>
                <div class="d-flex flex-row justify-content-center mt-2">
                    @if (currentCardAnswerRevealed == false)
                    {
                        <button tabindex="0" type="button" class="btn btn-primary" @onclick="HandleAnswer" @ref="answerButton">
                            Answer ü´•
                        </button>
                    }
                    else
                    {
                        <button tabindex="0" type="button" class="btn btn-primary mr-4" @onclick="HandleFeedback">
                            Bad ‚òπÔ∏è
                        </button>
                        <button tabindex="0" type="button" class="btn btn-primary" @onclick="HandleFeedback" @ref="goodButton">
                            Good üòÄ
                        </button>
                    }
                </div>
            }
        </div>
    }

    @if (newCardSelection != null)
    {
        @switch (newCardSelection)
        {
            case CardType.BasicNote:
                <NewBasicNote DeckId="@ArticleElement.Id"
                                        @bind-NewCardSelection="newCardSelection"
                                        @bind-Cards="Cards" />
                break;

            case CardType.ClozeNote:
                <NewClozeNote DeckId="@ArticleElement.Id"
                                        @bind-NewCardSelection="newCardSelection"
                                        @bind-Cards="Cards" />
                break;

            default:
                break;
        }
    }
}

@code {
    private CardType? newCardSelection = null;

    public required List<Card> Cards { get; set; }

    private int currentCardIndex = 0;

    private Card? currentCard;

    private bool currentCardAnswerRevealed = false;

    private bool studyingDeck = false;

    private async Task StudyDeck()
    {
        studyingDeck = true;
        await FocusAnswerButton();
    }

    private void CancelStudyDeck()
    {
        studyingDeck = false;
    }

    protected override void OnParametersSet()
    {
        studyingDeck = false;
        Cards = ArticleElement.Cards();
        currentCardIndex = 0;
        currentCard = GetNextCard();
    }

    private Card? GetNextCard()
    {
        if (currentCardIndex < Cards.Count)
        {
            return Cards[currentCardIndex];
        }
        else
        {
            return null;
        }
    }

    private ElementReference answerButton;

    private async Task FocusAnswerButton()
    {
        await Task.Delay(100);
        await answerButton.FocusAsync();
    }

    private ElementReference goodButton;

    private async Task FocusGoodButton()
    {
        await Task.Delay(100);
        await goodButton.FocusAsync();
    }

    private async Task HandleAnswer()
    {
        currentCardAnswerRevealed = true;
        await FocusGoodButton();
    }

    private async Task HandleFeedback()
    {
        currentCardAnswerRevealed = false;
        currentCardIndex += 1;
        currentCard = GetNextCard();
        if (currentCard != null)
        {
            await FocusAnswerButton();
        }
    }
}